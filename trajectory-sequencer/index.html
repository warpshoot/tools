<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËªåË∑°ÊèèÁîªÂûã„Ç∑„Éº„Ç±„É≥„Çµ„Éº - Trajectory Sequencer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 32px;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #4299e1;
            color: white;
        }

        button:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.danger {
            background: #f56565;
        }

        button.danger:hover {
            background: #e53e3e;
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
        }

        button.tool-btn {
            background: #48bb78;
        }

        button.tool-btn:hover {
            background: #38a169;
        }

        button.tool-btn.active {
            background: #2f855a;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 150px;
            cursor: pointer;
        }

        .speed-label {
            font-size: 14px;
            font-weight: 600;
            min-width: 80px;
            color: #4a5568;
        }

        .tracks-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .track {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .track-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .track-label {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
        }

        select {
            padding: 6px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            color: #2d3748;
        }

        select:focus {
            outline: none;
            border-color: #4299e1;
        }

        .track-controls {
            display: flex;
            gap: 8px;
        }

        .clear-btn {
            padding: 6px 16px;
            font-size: 12px;
            background: #ed8936;
        }

        .clear-btn:hover {
            background: #dd6b20;
        }

        .canvas-wrapper {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        canvas {
            display: block;
            width: 100%;
            cursor: crosshair;
        }

        canvas.eraser {
            cursor: cell;
        }

        .playback-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: rgba(255, 0, 0, 0.6);
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .track-1 .canvas-wrapper { background: linear-gradient(to bottom, #fef5e7, #fdebd0); }
        .track-2 .canvas-wrapper { background: linear-gradient(to bottom, #e8f8f5, #d1f2eb); }
        .track-3 .canvas-wrapper { background: linear-gradient(to bottom, #ebf5fb, #d6eaf8); }
        .track-4 .canvas-wrapper { background: linear-gradient(to bottom, #f4ecf7, #e8daef); }

        @media (max-width: 800px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .controls {
                gap: 10px;
                padding: 15px;
            }

            button {
                padding: 8px 16px;
                font-size: 12px;
            }

            .slider-group {
                width: 100%;
            }

            input[type="range"] {
                flex: 1;
            }
        }

        .instructions {
            text-align: center;
            color: #718096;
            font-size: 12px;
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ ËªåË∑°ÊèèÁîªÂûã„Ç∑„Éº„Ç±„É≥„Çµ„Éº</h1>
        <p class="subtitle">Draw lines to create music - Á∑ö„ÇíÊèè„ÅÑ„Å¶Èü≥Ê•Ω„Çí‰Ωú„Çç„ÅÜ</p>

        <div class="controls">
            <div class="control-group">
                <button id="playBtn">‚ñ∂ ÂÜçÁîü</button>
                <button id="stopBtn">‚ñ† ÂÅúÊ≠¢</button>
            </div>

            <div class="slider-group">
                <label class="speed-label">ÈÄüÂ∫¶: <span id="speedValue">1.0</span>x</label>
                <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
            </div>

            <div class="control-group">
                <button id="penBtn" class="tool-btn active">‚úèÔ∏è „Éö„É≥</button>
                <button id="eraserBtn" class="tool-btn">üßπ Ê∂à„Åó„Ç¥„É†</button>
            </div>

            <button id="clearAllBtn" class="danger">üóëÔ∏è ÂÖ®„ÇØ„É™„Ç¢</button>
        </div>

        <div class="tracks-container">
            <div class="track track-1" data-track="0">
                <div class="track-header">
                    <div class="track-info">
                        <span class="track-label">Track 1</span>
                        <select class="timbre-select">
                            <option value="square">Square (Áü©ÂΩ¢Ê≥¢)</option>
                            <option value="triangle">Triangle (‰∏âËßíÊ≥¢)</option>
                            <option value="sawtooth">Sawtooth („Éé„Ç≥„ÇÆ„É™Ê≥¢)</option>
                            <option value="sine">Sine (Ê≠£Âº¶Ê≥¢)</option>
                        </select>
                    </div>
                    <div class="track-controls">
                        <button class="clear-btn">„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
                <div class="canvas-wrapper">
                    <canvas width="1200" height="120"></canvas>
                    <div class="playback-line" style="display: none;"></div>
                </div>
            </div>

            <div class="track track-2" data-track="1">
                <div class="track-header">
                    <div class="track-info">
                        <span class="track-label">Track 2</span>
                        <select class="timbre-select">
                            <option value="square">Square (Áü©ÂΩ¢Ê≥¢)</option>
                            <option value="triangle" selected>Triangle (‰∏âËßíÊ≥¢)</option>
                            <option value="sawtooth">Sawtooth („Éé„Ç≥„ÇÆ„É™Ê≥¢)</option>
                            <option value="sine">Sine (Ê≠£Âº¶Ê≥¢)</option>
                        </select>
                    </div>
                    <div class="track-controls">
                        <button class="clear-btn">„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
                <div class="canvas-wrapper">
                    <canvas width="1200" height="120"></canvas>
                    <div class="playback-line" style="display: none;"></div>
                </div>
            </div>

            <div class="track track-3" data-track="2">
                <div class="track-header">
                    <div class="track-info">
                        <span class="track-label">Track 3</span>
                        <select class="timbre-select">
                            <option value="square">Square (Áü©ÂΩ¢Ê≥¢)</option>
                            <option value="triangle">Triangle (‰∏âËßíÊ≥¢)</option>
                            <option value="sawtooth" selected>Sawtooth („Éé„Ç≥„ÇÆ„É™Ê≥¢)</option>
                            <option value="sine">Sine (Ê≠£Âº¶Ê≥¢)</option>
                        </select>
                    </div>
                    <div class="track-controls">
                        <button class="clear-btn">„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
                <div class="canvas-wrapper">
                    <canvas width="1200" height="120"></canvas>
                    <div class="playback-line" style="display: none;"></div>
                </div>
            </div>

            <div class="track track-4" data-track="3">
                <div class="track-header">
                    <div class="track-info">
                        <span class="track-label">Track 4</span>
                        <select class="timbre-select">
                            <option value="square">Square (Áü©ÂΩ¢Ê≥¢)</option>
                            <option value="triangle">Triangle (‰∏âËßíÊ≥¢)</option>
                            <option value="sawtooth">Sawtooth („Éé„Ç≥„ÇÆ„É™Ê≥¢)</option>
                            <option value="sine" selected>Sine (Ê≠£Âº¶Ê≥¢)</option>
                        </select>
                    </div>
                    <div class="track-controls">
                        <button class="clear-btn">„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
                <div class="canvas-wrapper">
                    <canvas width="1200" height="120"></canvas>
                    <div class="playback-line" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="instructions">
            üí° ‰Ωø„ÅÑÊñπ: „Éö„É≥„É¢„Éº„Éâ„ÅßÁ∑ö„ÇíÊèè„Åç„ÄÅÂÜçÁîü„Éú„Çø„É≥„ÇíÊäº„Åô„Å®Èü≥„ÅåÈ≥¥„Çä„Åæ„Åô„ÄÇ<br>
            Á∏¶„ÅÆ‰ΩçÁΩÆ„ÅßÈü≥Á®ã„ÅåÂ§â„Çè„Çä„ÄÅ‰∏ä„ÅåÈ´òÈü≥„ÄÅ‰∏ã„Åå‰ΩéÈü≥„Åß„Åô„ÄÇË§áÊï∞„ÅÆ„Éà„É©„ÉÉ„ÇØ„ÅßÂíåÈü≥„ÇÇ‰Ωú„Çå„Åæ„Åô„ÄÇ
        </div>
    </div>

    <script>
        // ==================== Global State ====================
        const state = {
            isPlaying: false,
            playbackPosition: 0,
            speed: 1.0,
            tool: 'pen', // 'pen' or 'eraser'
            tracks: [],
            animationId: null,
            lastTime: 0,
            audioContext: null
        };

        // ==================== Audio Setup ====================
        function initAudio() {
            if (!state.audioContext) {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // C Major Scale: C4 to C5
        const SCALE = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];

        function yToFrequency(y, canvasHeight) {
            const index = Math.floor((1 - y / canvasHeight) * 8);
            return SCALE[Math.max(0, Math.min(7, index))];
        }

        function playNote(frequency, timbre, duration = 0.1) {
            initAudio();
            const ctx = state.audioContext;
            const now = ctx.currentTime;

            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.type = timbre;
            oscillator.frequency.setValueAtTime(frequency, now);

            // ADSR Envelope
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01); // Attack
            gainNode.gain.linearRampToValueAtTime(0.15, now + 0.06); // Decay to Sustain
            gainNode.gain.setValueAtTime(0.15, now + duration - 0.1); // Sustain
            gainNode.gain.linearRampToValueAtTime(0, now + duration); // Release

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.start(now);
            oscillator.stop(now + duration);
        }

        // ==================== Track Class ====================
        class Track {
            constructor(element, index) {
                this.element = element;
                this.index = index;
                this.canvas = element.querySelector('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.playbackLine = element.querySelector('.playback-line');
                this.timbreSelect = element.querySelector('.timbre-select');
                this.clearBtn = element.querySelector('.clear-btn');

                this.paths = []; // Array of path arrays
                this.currentPath = null;
                this.isDrawing = false;
                this.lastX = 0;
                this.lastPlaybackX = -10;

                this.setupCanvas();
                this.setupEvents();
            }

            setupCanvas() {
                this.drawGrid();
            }

            drawGrid() {
                const w = this.canvas.width;
                const h = this.canvas.height;

                this.ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                this.ctx.lineWidth = 1;

                // Vertical lines (8 divisions)
                for (let i = 1; i < 8; i++) {
                    const x = (w / 8) * i;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, h);
                    this.ctx.stroke();
                }

                // Horizontal lines (8 divisions)
                for (let i = 1; i < 8; i++) {
                    const y = (h / 8) * i;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(w, y);
                    this.ctx.stroke();
                }
            }

            setupEvents() {
                // Mouse events
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseleave', () => this.stopDrawing());

                // Touch events
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDrawing(e.touches[0]);
                });
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.draw(e.touches[0]);
                });
                this.canvas.addEventListener('touchend', () => this.stopDrawing());

                // Clear button
                this.clearBtn.addEventListener('click', () => this.clear());
            }

            getCoordinates(e) {
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / rect.width;
                const scaleY = this.canvas.height / rect.height;

                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }

            startDrawing(e) {
                this.isDrawing = true;
                const pos = this.getCoordinates(e);
                this.lastX = pos.x;
                this.currentPath = [pos];
            }

            draw(e) {
                if (!this.isDrawing) return;

                const pos = this.getCoordinates(e);
                this.currentPath.push(pos);

                if (state.tool === 'pen') {
                    this.drawLine(this.lastX, this.currentPath[this.currentPath.length - 2].y, pos.x, pos.y);
                } else if (state.tool === 'eraser') {
                    this.erase(pos.x, pos.y);
                }

                this.lastX = pos.x;
            }

            stopDrawing() {
                if (this.isDrawing && state.tool === 'pen' && this.currentPath.length > 0) {
                    this.paths.push(this.currentPath);
                }
                this.isDrawing = false;
                this.currentPath = null;
            }

            drawLine(x1, y1, x2, y2) {
                this.ctx.strokeStyle = this.getTrackColor();
                this.ctx.lineWidth = 3;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';

                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.stroke();
            }

            erase(x, y) {
                const eraserSize = 20;
                this.ctx.clearRect(x - eraserSize / 2, y - eraserSize / 2, eraserSize, eraserSize);
                this.drawGrid(); // Redraw grid in cleared area
            }

            getTrackColor() {
                const colors = ['#d68910', '#148f77', '#1f618d', '#7d3c98'];
                return colors[this.index];
            }

            clear() {
                this.paths = [];
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawGrid();
            }

            checkIntersection(x) {
                const imageData = this.ctx.getImageData(x, 0, 1, this.canvas.height);
                const data = imageData.data;
                const intersections = [];

                for (let y = 0; y < this.canvas.height; y++) {
                    const i = y * 4;
                    const alpha = data[i + 3];

                    // If there's a drawn pixel (not transparent)
                    if (alpha > 128) {
                        intersections.push(y);
                    }
                }

                return intersections;
            }

            updatePlaybackLine(x) {
                const percentage = (x / this.canvas.width) * 100;
                this.playbackLine.style.left = percentage + '%';
            }

            showPlaybackLine() {
                this.playbackLine.style.display = 'block';
            }

            hidePlaybackLine() {
                this.playbackLine.style.display = 'none';
            }

            getTimbre() {
                return this.timbreSelect.value;
            }
        }

        // ==================== Initialization ====================
        function init() {
            const trackElements = document.querySelectorAll('.track');
            trackElements.forEach((el, i) => {
                state.tracks.push(new Track(el, i));
            });

            setupControls();
        }

        function setupControls() {
            // Play/Stop
            document.getElementById('playBtn').addEventListener('click', play);
            document.getElementById('stopBtn').addEventListener('click', stop);

            // Speed slider
            const speedSlider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');
            speedSlider.addEventListener('input', (e) => {
                state.speed = parseFloat(e.target.value);
                speedValue.textContent = state.speed.toFixed(1);
            });

            // Tool buttons
            document.getElementById('penBtn').addEventListener('click', () => setTool('pen'));
            document.getElementById('eraserBtn').addEventListener('click', () => setTool('eraser'));

            // Clear all
            document.getElementById('clearAllBtn').addEventListener('click', clearAll);
        }

        function setTool(tool) {
            state.tool = tool;

            const penBtn = document.getElementById('penBtn');
            const eraserBtn = document.getElementById('eraserBtn');

            if (tool === 'pen') {
                penBtn.classList.add('active');
                eraserBtn.classList.remove('active');
                state.tracks.forEach(track => {
                    track.canvas.classList.remove('eraser');
                });
            } else {
                eraserBtn.classList.add('active');
                penBtn.classList.remove('active');
                state.tracks.forEach(track => {
                    track.canvas.classList.add('eraser');
                });
            }
        }

        function clearAll() {
            if (confirm('ÂÖ®„Å¶„ÅÆ„Éà„É©„ÉÉ„ÇØ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                state.tracks.forEach(track => track.clear());
            }
        }

        // ==================== Playback ====================
        function play() {
            if (state.isPlaying) return;

            initAudio();
            state.isPlaying = true;
            state.lastTime = performance.now();

            state.tracks.forEach(track => {
                track.showPlaybackLine();
                track.lastPlaybackX = -10;
            });

            animate();
        }

        function stop() {
            state.isPlaying = false;
            state.playbackPosition = 0;

            if (state.animationId) {
                cancelAnimationFrame(state.animationId);
                state.animationId = null;
            }

            state.tracks.forEach(track => {
                track.hidePlaybackLine();
                track.updatePlaybackLine(0);
            });
        }

        function animate(currentTime) {
            if (!state.isPlaying) return;

            const deltaTime = currentTime - state.lastTime;
            state.lastTime = currentTime;

            // Move playback position (60fps baseline, 1200px in 4 seconds at 1x speed)
            const baseSpeed = 1200 / (4 * 1000); // pixels per ms
            state.playbackPosition += deltaTime * baseSpeed * state.speed;

            // Loop when reaching the end
            if (state.playbackPosition >= 1200) {
                state.playbackPosition = 0;
                state.tracks.forEach(track => track.lastPlaybackX = -10);
            }

            // Update all tracks
            state.tracks.forEach(track => {
                track.updatePlaybackLine(state.playbackPosition);
                checkAndPlayNotes(track, Math.floor(state.playbackPosition));
            });

            state.animationId = requestAnimationFrame(animate);
        }

        function checkAndPlayNotes(track, x) {
            // Only check new positions
            if (x <= track.lastPlaybackX) return;

            const intersections = track.checkIntersection(x);

            if (intersections.length > 0) {
                // Play note for each intersection point
                intersections.forEach(y => {
                    const frequency = yToFrequency(y, track.canvas.height);
                    const timbre = track.getTimbre();
                    playNote(frequency, timbre);

                    // Visual feedback
                    flashIntersection(track, x, y);
                });
            }

            track.lastPlaybackX = x;
        }

        function flashIntersection(track, x, y) {
            const ctx = track.ctx;
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();

            // Fade out effect
            setTimeout(() => {
                track.ctx.clearRect(x - 10, y - 10, 20, 20);
                track.drawGrid();

                // Redraw paths in that area
                track.paths.forEach(path => {
                    for (let i = 1; i < path.length; i++) {
                        const p1 = path[i - 1];
                        const p2 = path[i];
                        if ((p1.x >= x - 10 && p1.x <= x + 10) || (p2.x >= x - 10 && p2.x <= x + 10)) {
                            track.drawLine(p1.x, p1.y, p2.x, p2.y);
                        }
                    }
                });
            }, 100);
        }

        // ==================== Start Application ====================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
